{% extends 'social/base.html' %}
{% load static %}

{% block title %}Feed - Midya{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    <div>
        <div class="card" style="margin-bottom: 2rem;">
            <h2 class="card-title">Activity Feed</h2>
        </div>
        
        {% for activity in activities %}
        <div class="activity-item">
            <p>{{ activity.description }}</p>
            <small style="color: var(--text-secondary);">{{ activity.created_at|date:"M d, Y H:i" }}</small>
        </div>
        {% empty %}
        <div class="card">
            <p style="color: var(--text-secondary); text-align: center;">No activities yet. Start following users to see their activities!</p>
        </div>
        {% endfor %}
        
        <div class="card" style="margin-top: 2rem;">
            <h2 class="card-title">All Posts</h2>
        </div>
        
        {% for post in posts %}
        <div class="post">
            <div class="post-header">
                <div style="display: flex; align-items: center; gap: 1rem; width: 100%; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        {% if post.user_profile_picture_url %}
                            <img src="{{ post.user_profile_picture_url }}" alt="{{ post.user }}" class="post-avatar">
                        {% else %}
                            <div class="post-avatar"></div>
                        {% endif %}
                        <div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <a href="{% url 'user_profile' post.user_id %}" class="post-user">{{ post.user }}</a>
                                {% if post.user_role == 'owner' %}
                                    <span class="role-badge role-owner">Owner</span>
                                {% elif post.user_role == 'admin' %}
                                    <span class="role-badge role-admin">Admin</span>
                                {% endif %}
                            </div>
                            <div class="post-time">{{ post.created_at|date:"M d, Y H:i" }}</div>
                        </div>
                    </div>
                    {% if post.can_delete %}
                    <button class="btn btn-small btn-danger" onclick="deletePost({{ post.id }})">Delete</button>
                    {% endif %}
                </div>
            </div>
            
            <div class="post-content">{{ post.content }}</div>
            
            {% if post.image_url %}
            <img src="{{ post.image_url }}" alt="Post image" class="post-image">
            {% endif %}
            
            <div class="post-actions">
                <button class="post-action-btn {% if post.is_liked %}liked{% endif %}" 
                        onclick="toggleLike({{ post.id }}, this)">
                    <span>❤️</span>
                    <span>{{ post.likes_count }}</span>
                </button>
            </div>
        </div>
        {% empty %}
        <div class="card">
            <p style="color: var(--text-secondary); text-align: center;">No posts yet. Create your first post!</p>
        </div>
        {% endfor %}
    </div>
    
    <div>
        <div class="card">
            <h3 class="card-title">Quick Actions</h3>
            <a href="{% url 'create_post' %}" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Create Post</a>
            <a href="{% url 'users_list' %}" class="btn btn-secondary" style="width: 100%; margin-top: 0.5rem;">Browse Users</a>
        </div>
    </div>
</div>

<script>
function toggleLike(postId, btn) {
    const isLiked = btn.classList.contains('liked');
    const url = `/api/posts/${postId}/like/`;
    const method = isLiked ? 'DELETE' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (method === 'POST') {
            btn.classList.add('liked');
            const countSpan = btn.querySelector('span:last-child');
            countSpan.textContent = parseInt(countSpan.textContent) + 1;
        } else {
            btn.classList.remove('liked');
            const countSpan = btn.querySelector('span:last-child');
            countSpan.textContent = parseInt(countSpan.textContent) - 1;
        }
    })
    .catch(error => console.error('Error:', error));
}

function deletePost(postId) {
    if (!confirm('Are you sure you want to delete this post?')) return;
    
    fetch(`/api/posts/${postId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.status === 204) {
            location.reload();
        } else {
            alert('Failed to delete post');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete post');
    });
}
</script>
{% endblock %}

